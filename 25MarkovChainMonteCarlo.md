# MCMC
## 简介
MCMC，全称Markov chain Monte Carlo，马尔可夫链蒙特卡洛，是一种使用随机抽样来近似复杂积分的方法。该方法由马尔可夫链核蒙特卡洛积分两部分组成。  
蒙特卡洛积分是利用有关分布的随机抽样来近似积分的一种有利方法，但从有关概率分布中抽样很困难或者无法直接做到，因此需要马尔可夫链，马尔可夫链是一种序贯模型，它以概率的方式从一种状态转移到另一种状态，其中链所采取的下一个状态取决于以前的状态（即马尔可夫性）。如果马尔可夫链构造得当并运行很长时间，那么它也将从目标概率分布中提取样本的状态，我们要做的就是构造马尔可夫链从想做积分的分布中抽样，然后利用蒙特卡洛积分来近似积分。
## 蒙特卡罗积分（Monte Carlo integration）
一般来说，当$x$为有分布的$\pi$的随机变量，想要计算函数$h(x)$的期望$E_\pi[h(x)]$时，需要计算积分  
$$E_\pi[h(x)]=\int h(x)\pi(x)dx$$  
该积分可能不容易求，特别是当$X$是高维变量时更难，但可以从分布$\pi$中抽样  
$$x^(1),x^(2),...,x^(n)~\pi,$$  
然后可以得到积分的近似  
$$E_\pi[h(x)]\approx \frac{1}{n} \sum_{i=1}^{n} h(w^{(i)})$$  
这就是蒙特卡洛积分。根据大数定理，当$n\rightarrow \infty$，有下面的依概率收敛  
$$\frac{1}{n} \sum_{i=1}^n \stackrel{p}{\rightarrow} E_\pi[h(x)]$$  

## 马尔可夫链（Markov chain）
当面对参数维数较高时，其先验和后验分布均是高维的，这种情况通常被描述为维度诅咒（curse of dimensionality）。这就意味着当维度增加时，空间x_j的体积增加得非常之快（以指数增加），可用的数据变得稀疏，数据的统计意义下降。  
为了解决这个问题，在利用抽样计算积分时，我们得选择一种方法使得我们能够以较小的样本得到好的近似。这种方法就是马尔可夫链。  
MCMC是一种使用马尔可夫链机制生成样本$x^{(i)}$的方法，这种方法的构造是为了使链花费更多时间在最重要的地方。特别的是，它的构造使样本$x^{(i)}$模拟从目标分布$p(x)$种提取样本，当然，用MCMC不能直接从$p(x)$中提取样本，但可以估计$p(x)$到一个标准化常数的程度。  
我们在有限空间$\chi = {x_1,x_2,...,x_s}$上直观引入马尔可夫链，令$x^{(i)}$为马尔可夫链的第$i$个状态，这里$x^{(i)}\in \chi$只能由$s$个离散值。满足下面性质的随机过程$x^{(i)}$被称为马尔可夫链：  
$$p(x^{(i)}|x^{(i-1)},x^{(i-2)},...x^{(1)})=p(x^{(i)}|x^{(i-1)}), \forall i$$  
式中的$p(x^{(i)}|x^{(i-1)})$称为从状态x^{(i-1)到状态(x^{(i)的转移概率。上式意味着随机过程处于某状态的概率仅依赖于前一个状态，与之前的历史无关，这就是马尔可夫性。  
下面介绍马尔可夫链中的几大概念：  
1. <b>时齐</b>  
如果对于任意两个状态$x_i,x_j \in \chi$，$s \times s$矩阵$\pmb P \equiv [p_{ij}]=[p(x^{(k)}|x^{(k-1)}=x_i)]$对所有$k$保持不变，而且$\sum_i P_{ij}=1$，则称马尔可夫链是时齐的。
2. <b>转移概率和转移概率矩阵</b>  
转移概率是马尔可夫链中的重要概念，若马氏链分为m个状态组成。从任意一个状态出发，经过任意一次转移，必然出现状态$1,2,...m$中的一个，这种状态之间的转移称为转移概率。   
其表达式为  $$P_{ij}(m,m+n)=P(X_{m+n}=j|X_m=i)$$
称$p_{ij}(m,m+n)$为链在$m$时刻处于$i$状态,再经$n$步转移到$j$状态的转移概率,简称$n$步转移概率。  
如果以$p_{ij}(m,m+n)$ 作为矩阵$\pmb P(m,m+n)$的第$i$行第$j$列元素,则$\pmb P(m,m+n)$称为马氏链的$n$步转移阵。值得注意的是,当$n=1$时，一步转移概率为$p_{ij}(m,m+1)$。其组成的是一步转移概率矩阵，记为$\pmb P_{ij}(m)$。  
    1. 转移概率性质  
    * 对一$\forall m,n,i,j$，有$p_{ij}(m,m+n)\geq 0$
    * 对$\forall m,n,i$，有$\sum_{j\in E}p_{ij}(m,m+n)=1$
    2. 一步转移概率矩阵性质
    * $0\leq \pmb P_{ij}(m) \geq 1,i\in I$
    * $\sum_{j\in I}\pmb P_{ij}(m)\leq 1$
    3. 转移矩阵条件  
    为了保证初始概率分布不影响后续稳定后的概率，转移矩阵需要满足以下两个条件：
    * 不可约性（irreducibility）  
    即非负性，从任何状态出发访问马尔可夫链的任何其他状态的概率都是正的。同时也意味着，转移矩阵不能再简化为更小的矩阵。  
    * 非周期性（aperiodicity）  
    马氏链不能被困在循环中，即需要马氏链是非周期性的。  
    假设有一个状态$x_i$，它经历$t$步之后回到自身状态的转移概率为$\pmb P_{ii}^t$，则周期为：  $$k=gcd(n|\pmb P_{ii}^n>0)$$
    式子中，$gcd$表示最大公约数。如果$k=1$，则状态$x_i$称为非周期性的。  
    如果每个状态都是非周期性的，那么马尔可夫链是非周期性的，一个不可约的马尔可夫链需要是非周期性的。
 
3. 平稳概率(stationary distribution)  
对于任意初始分布$\pmb \pi_0 = (\pi_1^{(0)},\pi_2^{(0)},...\pi_s^{(0)})$，在$t$次转换之后在各个状态的概率为向量  $$\pmb \pi_0\overbrace{PP...P}^t = \pmb \pi_0P^t$$
很容易验证，当$t$很大时，概率向量$\pi_0P^t$收敛到一个稳定的值$\pi$，而且该值和初始概率$\pi_0$无关，即  $$\lim_{t\rightarrow \infty}\pmb \pi_0P^t = \pmb \pi$$
乘积矩阵$\pmb P^t$的元素$P_{ij}^t$为从状态$x_i$经过$x$步转移到状态$x_j$的概率，显然有如下关系式：  $$\pmb \pi = \pmb \pi \pmb P$$
概率$\pmb \pi$称为平稳概率（stationary distribution或者equilibrium distribution），求解平稳概率即是求解$\pmb P^\mathsf{T}$特征值问题，这也是转移矩阵必须满足两大条件的一个原因。  
R的伪代码如下：
    ```R 
    状态转移矩阵P = matrix(矩阵数据)
    初始概率p0 = c(数据)
    p1 = p0  # 进行到下一步
    for(i in 1:迭代次数)
    P1 = P1%*%P
    P1  # 返回结果
    ```
    Python的伪代码如下：  
    ```Python
    状态转移矩阵A=[数据]
    阶段n步=状态转移矩阵A
    阶段n1步=np.dot(状态转移矩阵A,状态转移矩阵A)
    while not (阶段n步 == 阶段n1步).all():
        阶段n步 = 阶段n1步
        阶段n1步 = np.dot(阶段n1步,状态转移矩阵A)
    print(阶段n步)
    ```
    结合转移矩阵的非周期性和平稳概率，可以发现，如果从状态$x_i$总是可以到达$x_j$的概率为$\pi_j$对于所有$j$成立，或当$n\rightarrow \infty$  $$P_{ij}^n \rightarrow \pi_j,\forall j$$
    那么$\pmb \pi = (\pi_1,\pi_2,...\pi_s)$为不变的。除此之外，如果不可约的链有一个平稳的分布，那么该平衡分布是唯一的。
4. 遍历原理（erigodic theorem）  
所谓遍历原理，即指如果马尔可夫链  $$x^{(1)},x^{(2)},...x^{(n)}\sim \pmb \pi$$
是非周期性和不可约的，而且$\pmb \pi$是平稳分布，那么，当$n\rightarrow \infty$时，有  $$\frac{1}{n} \sum_n^{t=1}h(x^{(t)}) \rightarrow E_{\pmb \pi}[h(x)]=\int h(\pmb x)\pmb\pi(\pmb x)d\pmb x$$

## MCMC理论的主要性质
## MCMC的方法
### 方法综述
#### Metropolis算法
#### M-H算法
#### Gibb抽样
#### Hamiltonmian蒙特卡罗算法
## 参考文献
