# 决策分析（Decision Analysis）

## 一、背景：

早在1738年，伯努利就已提出决策分析中的效用概念。从1763年贝叶斯发表条件概率起就出现统计推断理论的萌芽。1815年拉普拉斯又将它推向一个新的阶段。统计推断理论实际上是在风险情况下的决策理论。1931年，拉姆齐基于效用和主观概率两个基本概念来研究决策理论。1944年 J.von诺伊曼和O.莫根施特恩在著名的《竞赛理论与经济行为》一书中，独立地研究了在不确定情况下进行决策所用的近代效用理论。沃尔德在1950年提出的统计决策函数是决策理论的又一重要进展。1954年萨维奇为决策方法提供了公理系统和严格的哲学基础。60年代初期，美国哈佛商学院开始运用统计决策理论解决商业问题，并定名为应用统计决策理论。1966年，美国霍华德首先应用决策分析这个名词。后来，决策分析又有许多新的发展，并广泛吸取有关的决策方法，从而形成一个内容广泛、实用性很强的学科分支。现代决策分析的发展动向是研究人们决策的行为思想方面和研制与计算机结合的决策支持系统等。

## 二、定义及基本方法：

### 2.1 决策分析的定义

决策分析一般指从若干可能的方案中通过决策分析技术，如期望值法或决策树法等，选择其一的决策过程的定量分析方法。决策分析本质上比统计推断更复杂，因为它设计对决策的优化以及对不确定性的平均。决策分析本质上比统计推断更复杂，因为它涉及对决策的优化以及对不确定性的平均。在这里简要地列出了贝叶斯决策分析的要素。

贝叶斯决策分析的数学定义如下：
1.	列举所有可能的决定和结果。
2.	确定每个决策选项d的x的概率分布。用贝叶斯术语来说，这是条件后验分布，p(x|d)。在决策分析框架中，决策d不具有概率分布。所以我们不能说p(d)或p(x)；所有的概率都必须以d为条件。
3.	定义一个效用函数U(x)，将结果映射到实数上。在简单的问题中，效用可能与单个连续的收益x相一致，例如寿命或净利润。如果结果x有多个属性，效用函数必须权衡不同的goods。
4.	计算期望效用E(U(x)|d)作为决策d的函数，并选择期望效用最高的决策。在决策树中，可能会有两个或更多的决策，期望效用必须在每个决策点计算，条件是在该点之前的所有可用信息。

一个完整的贝叶斯决策分析包括所有这四个步骤。

### 2.2 决策分析在不同情况下的方法
1.	确定性情况：每一个方案引起一个、而且只有一个结局。当方案个数较少时可以用穷举法，当方案个数较多时可以用一般最优化方法。
2.	随机性情况：也称风险性情况，即由一个方案可能引起几个结局中的一个，但各种结局以一定的概率发生。通常在能用某种估算概率的方法时，就可使用随机性决策，例如决策树的方法。
3.	不确定性情况:一个方案可能引起几个结局中的某一个结局,但各种结局的发生概率未知。这时可使用不确定型决策，例如拉普拉斯准则、乐观准则、悲观准则、遗憾准则等来取舍方案。
4.	多目标情况：由一个方案同时引起多个结局，它们分别属于不同属性或所追求的不同目标。这时一般采用多目标决策方法。例如化多为少的方法、分层序列法、直接找所有非劣解的方法等。
5.	多人决策情况：在同一个方案内有多个决策者，他们的利益不同，对方案结局的评价也不同。这时采用对策论、冲突分析、群决策等方法。

除上述各种方法外，还有对结局评价等有模糊性时采用的模糊决策方法和决策分析阶段序贯进行时所采用的序贯决策方法等。

当明确地平衡不确定性下的决策选项的成本和收益时，我们可以使用两种贝叶斯推理方法。首先，决策通常取决于预测数量(例如在给定的医疗条件下康复的概率)，或者某一特定干预下的连续结果(如成本或功效)的期望值，而这又取决于未知参数，如回归系数和总体频率。我们使用后验推理来总结关于这些参数的不确定性，以及关于进入决策计算的预测的不确定性；我们使用贝叶斯推理的第二种方法是在决策分析中，根据先前决策所观察到的信息，确定相关参数和结果的条件分布，这种计算出现在多阶段决策树中，特别是在评估信息的预期价值时。

## 三、两种决策分析方法

### 3.1 决策树

决策树是在已知各种情况发生概率的基础上，通过构成决策树来求取净现值的期望值大于等于零的概率，评价项目风险，判断其可行性的决策分析方法，是直观运用概率分析的一种图解法，决策树法有利于决策人员使决策问题形象比，可把各种可以更换的方案、可能出现的状态、可能性大小及产生的后果等，简单地绘制在一张图上，以便计算、研究与分析，同时还可以随时补充和不确定型情况下的决策分析。构建决策树的过程中常用的指标是信息增益，还有Gini值和信息增益比,下面以信息增益为主介绍这几个指标。

#### 3.1.1 指标计算公式

对于待划分的数据集D，其划分前样本集合D的熵（总体的经验熵）是一定的，但是根据某个特征X划分之后的熵（X条件经验熵）是不定的，X条件经验熵越小说明使用此特征划分得到的子集的不确定性越小（也就是纯度越高），因此$ 总体经验熵 -  X条件经验熵 $差异越大，说明使用当前特征划分数据集D的话，其纯度上升的更快。而我们在构建最优的决策树的时候总希望能更快速到达纯度更高的集合，这一点可以参考优化算法中的梯度下降算法，每一步沿着负梯度方法最小化损失函数的原因就是负梯度方向是函数值减小最快的方向。同理：在决策树构建的过程中我们总是希望集合往最快到达纯度更高的子集合方向发展，因此我们总是选择使得信息增益最大的特征来划分当前数据集D。

由上我们知道计算信息增益（ID3算法）首先需要计算出总体的经验熵和条件经验熵，假设样本D有n个类别（特征），每个类别（特征）的概率是$ \frac{|C_n|}{D} $，其中$ |C_n| $表示类别（特征）n的样本个数，|D|表示样本总数，那么总体的经验熵计算公式如下：$$ H(D) = -\sum_{n=1}^N{\frac{|C_n|}{|D|}\log_2\frac{|C_n|}{|D|}} $$

X条件经验熵计算公式如下：$$ H(D|X) = \sum_{i=1}^n{p_iH(D|X=x_i)} $$

则X的信息增益计算Gain(X)公式为：$$ Gain(D，X) = H(D) - H(D|X) $$

使用信息增益法（ID）存在信息增益偏向取值较多的特征的缺点，因为当特征的取值较多时，根据此特征划分更容易得到纯度更高的子集，因此划分之后的熵更低，由于划分前的熵是一定的，因此信息增益更大，信息增益比较偏向取值较多的特征。

因此当样本D中特征的取值较多时，可以使用信息增益比（C4.5算法）作为指标，信息增益比的本质是在信息增益的基础之上乘上一个惩罚参数，当特征个数较多时，惩罚参数较小；特征个数较少时，惩罚参数较大，因此其计算公式为：$$ 信息增益比 = 信息增益 * 惩罚参数 $$

惩罚参数计算公式：$$ 惩罚参数 = \frac{1}{H_X (D)} = \frac{1}{-\sum_{i=1}^n{\frac{|D_i|}{|D|}\log_2\frac{|D_i|}{|D|}}} $$
其中的$ H_X(D) $是对于样本集合D，将当前特征X作为随机变量（取值是特征X的各个特征值），求得的经验熵。

最终得到X的信息增益比：$$ g_R (D,X) = \frac{Gain(D,X)}{H_X (D)} $$

信息增益比偏向取值较少的特征，因为当特征取值较少时$ H_X(D) $的值较小，因此其倒数较大，因而信息增益比比较大，因而偏向取值较少的特征。所以在使用信息增益比时并不是直接选择信息增益率最大的特征，而是现在候选特征中找出信息增益高于平均水平的特征，然后在这些特征中再选择信息增益率最高的特征。

除了信息增益和信息增益比这两个指标，常用的指标还有基尼指数（CART算法），基尼指数表示在样本集合中一个随机选中的样本被分错的概率，基尼指数越小表示集合中被选中的样本被分错的概率越小，也就是说集合的纯度越高，反之，集合越不纯，即$$ 基尼指数（基尼不纯度）= 样本被选中的概率 * 样本被分错的概率 $$

数学公式表示为：$$ Gini = \sum_{k=1}^K{p_k(1-p_k)} = 1 - \sum_{k=1}^K{p_k ^2} $$

其中$ p_k $表示选中的样本属于k类别的概率，则这个样本被分错的概率是$ (1-p_k) $,样本集合中有K个类别，一个随机选中的样本可以属于这k个类别中的任意一个，因而对类别就加和,当样本为二分类样本时，$ Gini(P) = 2p(1-p) $

对于样本集合D：$$ Gini(D) = \sum_{n=1}^N{(\frac{|C_n|}{|D|})^2} $$

需要说明的是CART算法生成的是个二叉树，也就是当使用某个特征划分样本集合只有两个集合：
1.  等于给定的特征值的样本集合$ D_1 $。
2.  不等于给定的特征值的样本集合$ D_2 $。

实际上是对拥有多个取值的特征的二值处理，因而对于一个具有多个取值（超过2个）的特征，需要计算以每一个取值作为划分点，对样本D划分之后子集的纯度$ Gini(D,X_i) $，(其中$ X_i $表示特征X的可能取值),然后从所有的可能划分的$ Gini(D,X_i) $中找出Gini指数最小的划分，这个划分的划分点，便是使用特征X对样本集合D进行划分的最佳划分点。

#### 3.1.2 构建决策树

1.  在数据集中计算出所有特征的信息增益指标（或信息增益比、Gini指数）。
2.  挑选信息增益最大的X，然后按X的分组进行拆分数据集（例如X=1,2,3，则拆成3组,即X=1,2,3所对应的3个数据集），而信息增益最大的X将作为根进行判断。
3.  依次在拆分后的数据集中继续计算出其他特征的信息增益。
4.  继续挑选信息增益最大的特征，继续分组拆分，以此递归循环，直到满足以下两个条件之一，便可以停止循环。第一个条件：拆分后的数据集，只有y，没有x；这种情况是属于无法继续拆分，此时取y的众数为叶；第二个条件：拆分后的数据集，y列只有1个类别；例如在y全等于1的情况下，无论怎么拆分，y始终为1，那就没有继续拆分的必要了。

### 3.2 贝叶斯决策：以氡测量的层次决策分析为例

下面通过一个实例来了解贝叶斯推理在决策中的使用，示例结合了贝叶斯层次建模、概率决策分析和效用分析，平衡了暴露于氡气体的风险与测量房屋内氡水平并可能进行补救的成本。我们把这种分析看作是推理与决策分析完全集成的原型，超出了大多数应用程序的实际或可行范围，但表明了贝叶斯层次回归建模和个人集中决策之间的联系。

#### 3.2.1 背景

氡是一种致癌物质，是一种自然产生的放射性气体，其衰变产物也具有放射性，在高浓度下会导致肺癌。根据一项美国调查，氡平均照射量的分布近似为对数正态分布，几何平均值为0.67pCi/L，几何标准差为3.1(该分布的中位数为0.67 pCi/L，平均值为1.3pCi/L)。在美国，绝大多数房屋的氡含量并不高:约84%的房屋氡浓度低于2pCi/L。约90%低于3pCi/L。然而，调查数据显示，5万至10万户家庭的主要居住空间氡浓度超过20pCi/L，这一水平造成的年辐射照射量大致相当于铀矿工人的职业照射极限。

我们的决策问题包括测量氡浓度，并利用这一信息来帮助决定是否采取措施减少氡的风险。

在美国，最常用的测量方法是“筛选”测量法，这种短期测量是对居住区域年平均氡水平向上偏置的测量，在纠正了偏见之后。房屋的短期测量具有近似的对数正态分布，几何标准差约为1.8。

另一种氡测量方法远不如筛查测量方法常见，但在评估氡风险方面要好得多，那就是对氡浓度进行12个月的综合测量。长期观测直接测量了生活区域的年平均氡浓度。几何标准偏差约为1.2，成本约为50美元。在下面的讨论中，我们发现从成本效益的角度来看，长期度量比短期度量更有效。

如果家中的氡水平足够高，则个人可采取行动控制氡造成的风险，目前大多数家庭首选的补救方法是“分板减压”，它可以密封地板并增加通风，包括额外的取暖和制冷成本在内，成本约为2000美元，为简单起见，我们假设修复可以将氡浓度降低到2pCi/L，若初始年居住面积平均水平小于2 pCi/L，则整治无效。

#### 3.2.2 个人决策问题

我们认为个人业主有三种选择:
1.  在不监测的情况下进行补救:花费2000美元对房屋进行补救，将氡暴露减少到2pCi/L。
2.  什么都不做，接受目前的氡暴露。
3.  对房子进行长期测量，花费50美元，根据测量的结果，决定是补救还是什么都不做。

测量/补救决策通常必须在不确定的情况下作出，因为大多数房屋没有测量氡。即使在测量后，氡水平也不能确切知道，因此，决策分析提出了两个挑战:首先，决定是否在已知氡照射的情况下进行补救;第二，考虑到目前关于家庭氡的知识状况，决定是否值得测量氡暴露。

目前已知房主的先验分布，这种先验分布不是一个主观量;相反，我们通过对一个国家氡测量样本的层次分析来确定它，如下所述。

#### 3.2.3 在确定情况下的决策

在进行统计分析之前，我们调查已知氡暴露的房主的最佳决策，这个问题很难，因为它需要金钱和生命。我们用三个量来表示确定性下的决定，在线性无阈值剂量-反应关系下等效。
1.  $ D_d $，与肺癌死亡概率降低$ 10^-6 $相关的的美元价值(本质上是“微生命”的价值):
2.  $ D_r $, 家庭氡浓度在30年内降低1pCi/L的美元值;
3.  $ D_action $，如果你的氡水平是已知的，那么你应该补救的房屋氡水平。

采取行动的适当氡水平$ R_action $取决于减少氡的美元价值和补救措施的效益。我们假设，补救措施使房屋居住区域的年平均氡水平在高于该水平时降至$ R_remed = 2pCi/L $水平，但在低于该水平时保持不变。然后，行动水平被确定为补救的收益($$ D_r $($ R_action − R_remed$))等于成本($2000)的值，$$ R_action = $2000/D_r + R_remed $$

美国、英语、瑞典、加拿大政府建议的补救水平分别为$ R_action $ = 4,5,10和20pCi/L，若$ R_remed $ = 2pCi/L，则相当于每pCi/L$ D_r $的等价成本分别为1000美元、670美元、250美元和111美元。对于一个普通的美国家庭来说，这意味着每个微生命的$ D_r $值分别为0.21美元、0.14美元、0.05美元和0.02美元。作为比较，美国和英国对氡行动水平的建议相当于可接受的减少风险支出范围的低端。加拿大和瑞典的建议对氡风险相对漫不经心，因为每个微生命的隐含美元价值低于通常为其他风险假定的价值。

我们的计算(假设是一个普通的美国家庭)掩盖了各个家庭之间的巨大差异。例如,包含一个不抽烟男性和一个不抽烟的女性,并且愿意每人花0.21美元来减少$ 10^-6 $患肺癌的概率（此时$ D_d = 0.21 $美元）的家庭，应该为减少每pCi /L氡花370美元，因为他们患肺癌的风险小于平均美国家庭。因此，对于这样一个家庭来说，合适的行动水平是$ R_action = 7.4pCi/L $，可以与普通家庭的$ R_action = 4 $相比较。相比之下，如果男性和女性都是吸烟者，他们应该愿意为每pCi/L支付更高的1900美元，因为他们患肺癌的风险更高，因此他们的行动水平应该是$ R_action = 3.1pCi/L $。

#### 3.2.4 县氡水平的贝叶斯推断

前面的讨论涉及确定性下的决策，个人房主可能对其住宅的氡暴露水平了解有限。一些研究人员的目标是确定与高水平氡平均照射量的家庭相关的地点和预测变量，以便有效地集中监测和补救。

1.  从大约5000个房屋进行长期测量，随机选取125个县作为整群样本。
2.  对美国所有县随机抽取的约8万所房屋进行了短期测量。

这是我们有时会看到的一种模式:相对少量的准确数据，伴随着大量有偏见和不精确的数据。其挑战在于用好的数据来校准坏的数据，这样就可以对整个国家做出推断，而不仅仅是长期测量样本中的125个县。

#### 3.2.5 层次模型

我们同时校准数据并预测氡水平，通过在房屋和县这一级上使用预测器，将分层模型拟合到两组测量值中，并使用单独的模型拟合到美国10个地区中的每一个。让$ y_i $表示对县$ j_(i) $房子i的氡测量值的对数，X表示家庭级预测值矩阵，包括房子是否有地下室以及地下室是否为居住区的指标，如果测量值i为短期筛选测量值，则指标变量等于1。包括指示器，用于校正筛选测量中的偏差。我们假设一个正态线性回归模型，$$ y_i ~ N(X_i\beta+\alpha_j(i)，\sigma_i ^2), for &emsp; houses &emsp; i = 1,...,n, $$

其中$ \alpha_j(i) $是县域效应，根据测量i是长期还是短期，数据级方差参数$ \sigma_i $可以有两个可能的值。县参数$ \alpha_j $也假定为正态分布，$$ \alpha_j ~ N(W_j\gamma + \delta_k(j),\tau^2), j = 1,...,J, $$

利用包括气候数据和土壤中铀含量测量在内的县级预测指标W，表征j县地质特征的指标$ \delta_k(j) $为K = 19类型之一。最后，根据数据估算了19种地质类型的$ δ_k $系数，$$ \delta_k ~ N(0,\kappa^2), for &emsp; geologic &emsp; type k = 1,...,K, $$

还有递阶方差分量$ \tau $和$ \kappa $。最后，我们将全美国划分为10个区域，并在每个区域内分别拟合模型。

结合长期和短期测量，我们可以估计美国几乎每个县的氡水平分布，尽管主要取决于县内样本中的房屋数量，存在很大的不确定性。

#### 3.2.6 推断

不幸的是(从减少氡的角度来看)，室内氡浓度即使在小范围内也变化很大。考虑到预测包含在模型中,氡水平的个体在一个指定的县只能预测内最多约1.9倍(也就是说,后几何标准差是1.9),和2.3倍更典型,考虑到3.1的因素，这是一个令人失望的巨大预测不确定性，因为除了房子在美国以外，没有任何关于房子的信息。另一方面,在美国这个看似温和的减少不确定性仍足以识别一些地区氡含量较高的家庭是非常罕见或非常常见的。例如，在大西洋中部各州。在一些县，超过一半的房屋的长期居住面积浓度超过了环保署建议的4pCi/L的行动水平，而在其他县，超过这个水平的不到0.5%。

#### 3.2.7 单户住宅氡水平的贝叶斯推断

我们使用拟合的层次回归模型对之前未测量的房屋i进行推理和决策分析，使用以下符号:
$$ R_i = 房屋i的氡浓度 $$
$$ \theta_i = \log(R_i) $$

对于房屋i的决策，我们需要给定$ \theta_i $的后验预测分布，对回归系数、县效应和方差分量的后验不确定性进行平均;它将近似正态(因为方差分量被很好地估计)，我们将它标记为：$$ \theta_i ~ N(M_i,S_i ^2) $$

其中$ M_i $和$ S_i $由模型估计的后验模拟计算得到。均值是$ M_i = X_i \stackrel{^}{\beta} + \stackrel{^}{\alpha_j(i)}，其中$ X_i $是一个列向量，包含住宅i的房屋水平预测指标(指示房屋是否有地下室以及地下室是否为生活区的指标)，($ stackrel{^}{\beta} $，$ stackrel{^}{\alpha} $)是该国相应地区分析的后均值。方差$ S_i ^2 $(由早期后验计算得到)包括系数$ \alpha $,$ \beta $中的后验不确定性，以及层次方差分量$\tau^2$和$\kappa^2$。(我们预测的是实际的氡水平，而不是测量值，因此$ \sigma^2 $在这里不起作用。)结果表明，家庭氡水平预测分布的几何标准差$ e^S $在2.1到3.0之间变化，大多数美国家庭的几何标准差$ e^S $在(2.1、2.5)范围内。($ e^S > 2.5 $的房屋位于人口较少的县，在氡调查中获得的信息很少，因此这些县的预测不确定性相对较高。)房屋预测分布的几何平均值$ e^M $在0.1到14.6pCi/L之间变化，95%在0.3、3.7范围内，50%在0.6、1.6范围内。预测几何均值最高的住宅为高氡水平的县的地下室住宅;预测几何平均值最低的房子没有地下室，而且位于氡含量低的县。

分布(9.5)总结了关于房屋氡水平的知识状态，只给出了其县和地下室的信息。在这方面，它作为房主的优先分配。现在假设在室内测量$ y ~ N(\theta， \sigma^2) $。(我们假设一个无偏的测量。如果使用短期测量，则必须对回归模型中估计的偏差进行修正。)在我们的表示法中，y和$ \theta $分别是测量值和真实家庭氡水平的对数。$ \theta $的后验分布为：$$ \theta|M,y ~ N(\Lambda,V) $$
其中$$ \Lambda = \frac{\frac{M}{S^2}+\frac{y}{\sigma^2}}{\frac{1}{S^2}+\frac{1}{\sigma^2}} &emsp; V = \frac{1}{\frac{1}{S^2}+\frac{1}{\sigma^2} $$

我们根据分布$ \theta_i $和$ \theta $对何时度量和何时纠正进行决策分析。

#### 3.2.8 个体业主的决策分析

我们现在根据预测的家庭氡水平、氡导致肺癌死亡的额外风险、修复的影响和个人对风险的态度，制定出最优的测量和修复决策。给定一个行动水平下确定，$ R_action $，我们处理的问题，是否支付一个家庭氡测量和是否进行补救。是否测量的决定取决于你家氡水平的先验分布$ \theta_i $，鉴于你的预测器X。我们使用术语“先验分布”来指代基于我们的层次模型的预测分布:调查数据的预测分布条件，但这是在考虑任何具体测量房屋之前。是否进行补救的决定取决于后验分布$ \theta $，如果已经进行了测量，则取决于先验分布$ \theta_i $。在我们的计算中，我们使用以下正态分布的结果:如果$ z ~ N(\mu,s^2) $，那么$ E(e^z) = e^\mu+\frac{1}{2}s^2 $和$ e^z|Z > a)Pr(z > a)= e^\mu+\frac{1}{2}s^2 + (1-\Phi(\frac{\mu+s^2-a}{s}))，其中$ \Phi $是标准正态累积分布函数。











